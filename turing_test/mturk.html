<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://perpetual-static-cdn.s3.amazonaws.com/resgen-annotation/design-style.css">

<crowd-form>
    <!--<input name="annotations" id="annotations" type="hidden">-->
    <input name="ground_truths" id="ground_truths" type="hidden">
    <input name="annotations" id="annotations" type="hidden">

     <!-- Prevent crowd-form from creating its own button -->
    <crowd-button form-action="submit" style="display: none;"></crowd-button>
    <input hidden id="data" value='{{ task.input.data }}'><input>
    <input hidden id="source-ids" value='{{ task.input.ids }}'><input>
</crowd-form>

<!--crowd-form>
  <crowd-classifier
    name="response"
    categories="{{ task.input.labels }}"
    header="Pick the Most Appropriate Response to Dialog Context"
  >
    <classification-target id="target-dialog">
    Dialog to go here
    </classification-target>

    <input hidden id="data" value='{{ task.input.data }}'><input>
  </crowd-classifier>

</crowd-form-->


<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<div class="jumbotron text-center">
    <h2>Turing Test for Artificially Intelligent Dialog System</h2>
</div>

<div class="modal fade" id="incompleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="alertLabel">Alert</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Hello there, please annotate all the data points and then press "Submit".
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
    <div id="nonsense">
        <h3>Instructions</h3>
        <ol>
            <li><strong>Read</strong> the dialog history/<strong>context</strong> carefully.</li>
            <li><strong>Read</strong> the <strong>individual</strong> <strong>responses</strong> carefully.</li>
            <li><strong>Choose the response label</strong> that best suits the context in terms of grammatical correctness and coherence to the context.</li>
            <li>Read the <strong>example</strong> in <strong>full instructions</strong> to understand more about the task.</li>
        </ol>
        <p>
          <button class="btn btn-link" type="button" data-toggle="modal" data-target="#exampleModal" aria-expanded="false" aria-controls="collapseExample">
            See Full Instructions
          </button>
        </p>
        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Full Instructions</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <h4>Dialog Response Selection</h4>
                <p>Each data sample consists of a base dialog context and several candidate responses. Your task is to choose the best response among all the candidates. Following is an example data sample,</p>
                <p><br />
                    <img
                            class="img-fluid" style="display: block; margin-left: auto; margin-right: auto; "
                            src="https://i.stack.imgur.com/U93bk.png" alt="Instructions"
                    />
                </p>
                  <!--width="595" height="455"-->
                <p>In above example, the dialog context is <em>&ldquo;hello , i brought a lap - top computer with me . do you know how can i use the internet in my room ? &ldquo;.&nbsp;</em></p>
                <p>There are 3 candidate responses available in this sample, you have to choose the best one among these. If you think <em>Response 1 </em>is the best available response, please label this as <em>1.</em></p>
                <p>For comparing the available responses you need to consider two aspects of the responses,&nbsp;</p>
                <ul>
                <li><em>Coherence of the response to the dialog context.</em></li>
                </ul>
                <ul>
                <li>Grammatical correctness of the response.</li>
                </ul>
                <p><br /><br /></p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>

        <div class="collapse" id="collapseExample">
          <div class="card card-body">

          </div>
        </div>
    </div>

    <div id="root"></div>

    <div align="center" class="mt-3">
        <crowd-button id="submitButton">Submit</crowd-button>
    </div>
    <div class="footer-copyright text-center py-3">Â© 2019 Copyright: Bishal Santra </div>
</div>


<script id="hit-template" type="text/x-custom-template">
    <div class="task mt-4">
        <h4 id="annot-id"></h4>
        <div class="container" id="content-box">

        </div>
        <form class="hit-form">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-4">
                        <label class="btn btn-danger btn-block input-container">
                            <div class="row justify-content-center">
                                <div class="col-5" align="right">
                                    <input type="radio" name="options" species="ai">
                                    <span class="checkmark"></span>
                                </div>
                                <div class="col-5" align="left">
                                    AI
                                </div>
                            </div>
                        </label>
                    </div>
                    <div class="col-4">
                        <label class="btn btn-success btn-block input-container">
                            <div class="row justify-content-center">
                                <div class="col-4" align="right">
                                    <input type="radio" name="options" species="human">
                                    <span class="checkmark"></span>
                                </div>
                                <div class="col-5" align="left">
                                    HUMAN
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!--<button type="submit" class="btn btn-primary">Submit</button>-->

        </form>
    </div>
</script>

<script id="user-odd" type="text/x-custom-template">
    <ul class="list-group mb-3">
        <li class="list-group-item d-flex justify-content-between lh-condensed">
            <img src="https://perpetual-static-cdn.s3.amazonaws.com/resgen-annotation/user1.png" alt="User 0" style="max-height: 40px" class="img-fluid">
            <p class="message"></p>
        </li>
    </ul>
</script>

<script id="user-even" type="text/x-custom-template">
    <ul class="list-group mb-3">
        <li class="list-group-item d-flex justify-content-between lh-condensed">
            <p class="message"></p>
            <img src="https://perpetual-static-cdn.s3.amazonaws.com/resgen-annotation/user2.png" alt="User 0" style="max-height: 40px" class="img-fluid">
        </li>
    </ul>
</script>

<script id="ai-odd" type="text/x-custom-template">
    <ul class="list-group mb-3">
        <li class="list-group-item d-flex justify-content-between lh-condensed">
            <img src="https://perpetual-static-cdn.s3.amazonaws.com/resgen-annotation/unknown.jpg" alt="User 0" style="max-height: 40px" class="img-fluid">
            <p class="message"></p>
        </li>
    </ul>
</script>

<script id="ai-even" type="text/x-custom-template">
    <ul class="list-group mb-3">
        <li class="list-group-item d-flex justify-content-between lh-condensed">
            <p class="message"></p>
            <img src="https://perpetual-static-cdn.s3.amazonaws.com/resgen-annotation/unknown.jpg" alt="User 0" style="max-height: 40px" class="img-fluid">
        </li>
    </ul>
</script>

<script>
    var data = JSON.parse($("#data").val());
    var source_ids = JSON.parse($("#source-ids").val());
    console.log(data.length);
    var u_odd_template = $("#user-odd").html();
    var u_even_template = $("#user-even").html();
    var ai_odd_template = $("#ai-odd").html();
    var ai_even_template = $("#ai-even").html();

    var hit_template = $("#hit-template").html();

    var ground_truth = {};
    for (var i=0; i < data.length; i++){
        var hit_obj = $(hit_template);
        hit_obj.find("#annot-id").html("Annotation Task #" + (i+1));
        _id = "id", "D_"+source_ids[i];
        hit_obj.find("form").attr(_id);

        turns = [];
        for (var k in data[i]){
            turns[k] = data[i][k];
        }

        T = Math.min(turns.length-1, 5);
        function FirstCap(m){
            m = m.replace("<unk>", "[HIDDEN]");
            return m[0].toUpperCase() + m.slice(1);
        }
        function addMessage(turn, m, ai){
            m = FirstCap(m.toLowerCase());
            if (turn%2 == 0){
                u_obj = ai? $(ai_odd_template) : $(u_odd_template);
               }
               else{
                u_obj = ai? $(ai_even_template) : $(u_even_template);
               }
            u_obj.find("p").html(m);
            hit_obj.find("#content-box").append(u_obj);
        }
        for (var j=0; j < T; j++){
            addMessage(j, turns[j]['gold'], false);
        }
        if(Math.random() > 0.5){
            // AI
            addMessage(T, turns[T]['resgen'], true);
            ground_truth[_id] = 'ai';
        }else{
            // Human
            ground_truth[_id] = 'human';
            addMessage(T, turns[T]['gold'], true);
        }

        $("#root").append(hit_obj);
    }

    var responses = {};
    document.querySelector('crowd-form').onsubmit = function() {
        console.log(responses);
        console.log(ground_truths);
        document.getElementById('annotations').value = JSON.stringify(responses);
        document.getElementById('ground_truths').value = JSON.stringify(ground_truths);

    };

    document.getElementById('submitButton').onclick = function() {
        // Add logic to make sure all fields are marked!
        var filled=true;
        responses = {};
        $("form.hit-form").each(function(what){
            var form = $(this);
            var id = form.attr("id");
            var selected_option = form.find(":checked").attr("species");
            console.log(selected_option);
            responses[id] = selected_option;
            if (typeof selected_option === 'undefined'){
                filled = false;
            }
        });
        if (filled){
            document.querySelector('crowd-form').submit();
        }else{
            $("#incompleteModal").modal("show");
        }
    };

</script>